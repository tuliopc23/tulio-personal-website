---
import Base from "../layouts/Base.astro";
import "../styles/section.css";
import Card from "../components/Card.astro";
import ProfileCard from "../components/ProfileCard.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import { getAllPosts } from "../sanity/lib/posts";

const posts = await getAllPosts();
const featuredWriting = posts.slice(0, 3);

const fallbackWriting = [
  {
    slug: "liquid-glass",
    title: "Liquid glass on the web",
    summary:
      "How to recreate Apple's materials with CSS blur, transparency, and borders.",
    tint: "blue" as const,
  },
  {
    slug: "sidebar-ux",
    title: "Sidebar UX like Apple Docs",
    summary: "Sticky sections, quick filter, and semantics.",
    tint: "teal" as const,
  },
  {
    slug: "system-fonts",
    title: "System font stacks",
    summary: "Use -apple-system and friends correctly.",
    tint: "orange" as const,
  },
];

const tintByTag: Record<string, string> = {
  design: "orange",
  accessibility: "teal",
  tooling: "blue",
  engineering: "blue",
  swift: "orange",
  frontend: "teal",
  ux: "blue",
  writing: "yellow",
};

const writingCards =
  featuredWriting.length === 0
    ? fallbackWriting.map((item) => ({
        title: item.title,
        summary: item.summary,
        href: `/blog/${item.slug}/`,
        tint: item.tint,
      }))
    : featuredWriting.map((post, index) => {
        const fallbackTint = fallbackWriting[index]?.tint ?? "indigo";
        const tagTint = post.tags
          .map((tag) => tintByTag[tag.toLowerCase()])
          .find(Boolean);
        return {
          title: post.title,
          summary: post.summary,
          href: `/blog/${post.slug}/`,
          tint: tagTint ?? fallbackTint,
        };
      });

const techStack = [
  {
    title: "Swift",
    body: "Native macOS and iOS development.",
    tint: "orange",
    icon: "swift",
  },
  {
    title: "TypeScript",
    body: "Structured web applications.",
    tint: "blue",
    icon: "typescript",
  },
  {
    title: "Rust",
    body: "Systems programming with safety.",
    tint: "brown",
    icon: "rust",
  },
  {
    title: "Zig",
    body: "Low-level ergonomics and performance.",
    tint: "yellow",
    icon: "zig",
  },
  {
    title: "Go",
    body: "Backend services and tooling.",
    tint: "cyan",
    icon: "go",
  },
  {
    title: "React",
    body: "Component-driven UI.",
    tint: "cyan",
    icon: "react",
  },
  {
    title: "Svelte",
    body: "Motion-forward, compiled interfaces.",
    tint: "orange",
    icon: "svelte",
  },
  {
    title: "Vue",
    body: "Progressive web app craftsmanship.",
    tint: "green",
    icon: "vue",
  },
  {
    title: "Docker",
    body: "Portable environments and deployment pipelines.",
    tint: "indigo",
    icon: "docker",
  },
];

const siteOrigin =
  Astro.site?.origin ?? Astro.url?.origin ?? "https://www.tuliocunha.dev";
const canonical = new URL("/", siteOrigin).toString();
const description =
  "Tulio Cunha is a full stack developer crafting native and web experiences with Apple-inspired precision.";
const heroImage = "/terminal-favicon.svg";
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: "Tulio Cunha",
  url: siteOrigin,
  jobTitle: "Full Stack Developer",
  description,
  sameAs: [
    "https://github.com/tuliopc23",
    "https://linkedin.com/in/tuliocunha",
    "https://instagram.com/tuliopinheirocunha",
  ],
};
---

<Base
  title="Home"
  description={description}
  canonical={canonical}
  ogDescription={description}
  ogImage={{ url: heroImage, alt: "Tulio Cunha portfolio hero" }}
  structuredData={structuredData}
  sidebar={true}
>
  <section
    class="hero container"
    data-reveal
    data-reveal-type="scale"
    data-reveal-group="home-hero"
  >
    <Breadcrumbs items={[{ label: "Home", icon: "home" }]} />
    <h1 class="hero__title">Hi, I'm Tulio Cunha.</h1>
    <p class="hero__subtitle">
      Full stack developer crafting native and web tools with calm detail and reliable
      execution.
    </p>
  </section>

  <section class="container home__section" data-reveal data-reveal-group="home-profile">
    <ProfileCard
      name="Tulio Cunha"
      title="Full Stack Developer"
      location="Brazil"
      email="contact@tuliocunha.dev"
    />
    <div class="home__quickLinks cardRail">
      <Card
        title="Projects"
        body="Projects spanning refined web UIs, full-stack builds, CLI tools, and systems programming."
        href="/projects"
        tint="orange"
        icon="projects"
        cta="Browse projects →"
        revealGroup="home-links"
        revealOrder={0}
      />
      <Card
        title="Blog"
        body="Notes on engineering, experiences, products, tastes, and tips worth sharing."
        href="/blog/"
        tint="blue"
        icon="blog"
        cta="Browse the journal →"
        revealGroup="home-links"
        revealOrder={1}
      />
    </div>
  </section>

  <section class="container" data-reveal data-reveal-group="home-tech">
    <h2
      class="section-title"
      data-reveal
      data-reveal-group="home-tech"
      data-reveal-order={0}
    >
      Tech stack
    </h2>
    <div class="cardGrid cardRail">
      {
        techStack.map((entry, index) => (
          <Card
            title={entry.title}
            body={entry.body}
            tint={entry.tint}
            icon={entry.icon}
            revealGroup="home-tech"
            revealOrder={index + 1}
          />
        ))
      }
    </div>
  </section>

  <section class="container" data-reveal data-reveal-group="home-writing">
    <h2
      class="section-title"
      data-reveal
      data-reveal-group="home-writing"
      data-reveal-order={0}
    >
      Featured writing
    </h2>
    <div class="cardGrid cardRail">
      {
        writingCards.map((entry, index) => (
          <Card
            title={entry.title}
            body={entry.summary}
            href={entry.href}
            tint={entry.tint}
            icon="writing"
            cta="Read article →"
            revealGroup="home-writing"
            revealOrder={index + 1}
          />
        ))
      }
    </div>
  </section>

  <script is:inline>
    // Scroll-linked parallax for hero gradient (0.3 velocity)
    const hero = document.querySelector(".hero");
    if (hero) {
      const updateParallax = () => {
        const scrollY = window.scrollY;
        const parallaxOffset = scrollY * 0.3;
        hero.style.setProperty("--parallax-offset", `${parallaxOffset}px`);
      };

      // Throttle scroll events for performance
      let ticking = false;
      const handleScroll = () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateParallax();
            ticking = false;
          });
          ticking = true;
        }
      };

      // Check for reduced motion preference
      const prefersReducedMotion = window.matchMedia(
        "(prefers-reduced-motion: reduce)"
      ).matches;
      if (!prefersReducedMotion) {
        window.addEventListener("scroll", handleScroll, { passive: true });
        updateParallax(); // Initial position
      }
    }
  </script>
</Base>
