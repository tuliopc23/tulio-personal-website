---
interface Props {
  value: {
    url: string;
    caption?: string;
  };
}

const { value } = Astro.props;
const { url, caption } = value;

// Extract video ID and determine platform
function getVideoInfo(url: string) {
  // YouTube
  const youtubeMatch =
    url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/) ||
    url.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/);

  if (youtubeMatch) {
    return {
      platform: "youtube",
      id: youtubeMatch[1],
      embedUrl: `https://www.youtube.com/embed/${youtubeMatch[1]}`,
      thumbnailUrl: `https://img.youtube.com/vi/${youtubeMatch[1]}/maxresdefault.jpg`,
    };
  }

  // Vimeo
  const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
  if (vimeoMatch) {
    return {
      platform: "vimeo",
      id: vimeoMatch[1],
      embedUrl: `https://player.vimeo.com/video/${vimeoMatch[1]}`,
      thumbnailUrl: null, // Vimeo thumbnails require API
    };
  }

  return null;
}

const _videoInfo = getVideoInfo(url);
---

{
  videoInfo && (
    <figure class="videoEmbed">
      <div class="videoEmbed__wrapper">
        <iframe
          src={videoInfo.embedUrl}
          title={caption || `${videoInfo.platform} video`}
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          loading="lazy"
        />
      </div>
      {caption && <figcaption class="videoEmbed__caption">{caption}</figcaption>}
    </figure>
  )
}

<style>
  .videoEmbed {
    margin: clamp(var(--space-lg), 5vw, 80px) auto;
    max-width: 100%;
  }

  .videoEmbed__wrapper {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
    border-radius: var(--radius-md);
    background: var(--surface);
    border: 1px solid var(--panel-border);
  }

  .videoEmbed__wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: var(--radius-md);
  }

  .videoEmbed__caption {
    margin-top: var(--space-xs);
    text-align: center;
    font-size: var(--fs--2);
    color: var(--muted);
  }
</style>
