---
import { Image } from "astro:assets";
import BrandIcon from "./BrandIcon.astro";
import SFIcon from "./SFIcon.astro";
import type { Project } from "../data/projects";

interface Props {
  project: Project;
  revealGroup?: string;
  revealOrder?: number | string;
  revealDelay?: string;
}

const {
  project,
  revealGroup = "projects-grid",
  revealOrder,
  revealDelay,
}: Props = Astro.props as Props;

const _mediaTint = project.media.type === "icon" ? (project.media.tint ?? "blue") : null;
const _hasImage = project.media.type === "image";

const releaseDate = project.releaseDate ? new Date(project.releaseDate) : null;
const _releaseLabel =
  releaseDate && !Number.isNaN(releaseDate.getTime())
    ? new Intl.DateTimeFormat("en", { month: "short", year: "numeric" }).format(releaseDate)
    : null;

let _originLabel: string | null = null;
try {
  const url = new URL(project.href);
  _originLabel = url.hostname.replace(/^www\./, "");
} catch {
  _originLabel = null;
}

const stackPrimary = project.stack.slice(0, 3);
const stackOverflow = project.stack.length - stackPrimary.length;
const _stackOverflowLabel = stackOverflow > 0 ? `+${stackOverflow} more` : null;
const _categoriesAttr = project.categories.join(",");
---

<a
  class="card projectCard"
  href={project.href}
  target="_blank"
  rel="noreferrer noopener"
  data-analytics-event={`project:${project.id}`}
  data-reveal
  data-reveal-group={revealGroup}
  data-reveal-order={revealOrder === undefined || revealOrder === null
    ? undefined
    : String(revealOrder)}
  data-reveal-delay={revealDelay ?? undefined}
  data-project-id={project.id}
  data-project-categories={_categoriesAttr}
  data-project-card
>
  <div class="projectCard__media" data-kind={_hasImage ? "image" : "icon"}>
    <div class="projectCard__frame" data-kind={_hasImage ? "image" : "icon"}>
      <div class="projectCard__chrome" aria-hidden="true">
        <span class="projectCard__chromeDot" data-variant="close"></span>
        <span class="projectCard__chromeDot" data-variant="minimize"></span>
        <span class="projectCard__chromeDot" data-variant="zoom"></span>
      </div>
      <div class="projectCard__viewport">
        {
          _hasImage ? (
            <Image
              src={project.media.src}
              alt={project.media.alt}
              widths={[320, 480, 640]}
              sizes="(max-width: 720px) 84vw, (max-width: 1040px) 50vw, 360px"
              formats={["avif", "webp"]}
              class="projectCard__image"
              loading="lazy"
              decoding="async"
              data-image-loading
            />
          ) : (
            <div
              class={`projectCard__icon symbol symbol--${_mediaTint ?? "blue"}`}
              aria-hidden="true"
            >
              <BrandIcon name={project.media.icon} size={36} />
            </div>
          )
        }
      </div>
    </div>
    <span class="projectCard__mediaGlow" aria-hidden="true"></span>
  </div>

  <div class="projectCard__body">
    <header class="projectCard__header">
      <div class="projectCard__heading">
        <p class="projectCard__eyebrow">{project.role}</p>
        <h3 class="projectCard__title">{project.title}</h3>
      </div>
    </header>

    {
      (_releaseLabel || _originLabel) && (
        <div class="projectCard__metaRow">
          {_releaseLabel && <span class="projectCard__meta">{_releaseLabel}</span>}
          {_originLabel && (
            <span class="projectCard__meta projectCard__meta--origin">{_originLabel}</span>
          )}
        </div>
      )
    }

    <p class="projectCard__summary">{project.summary}</p>

    <div class="projectCard__divider" aria-hidden="true"></div>

    <ul class="projectCard__stack" aria-label="Technology stack">
      {stackPrimary.map((tech) => <li class="projectCard__tag">{tech}</li>)}
      {
        _stackOverflowLabel && (
          <li class="projectCard__tag projectCard__tag--muted">{_stackOverflowLabel}</li>
        )
      }
    </ul>

    <span class="projectCard__cta">
      <span>{project.cta}</span>
      <SFIcon name="arrow-up-right" size={18} stroke={1.6} />
    </span>
  </div>
</a>
